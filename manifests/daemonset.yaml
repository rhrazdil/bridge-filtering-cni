---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: cidr-filtering
rules:
  - apiGroups:
      - ""
    resources:
      - configmaps
    verbs:
      - get
      - list
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: cidr-filtering
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cidr-filtering
subjects:
- kind: ServiceAccount
  name: cidr-filtering
  namespace: kube-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cidr-filtering
  namespace: kube-system
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: cidr-filtering-cni-ds
  namespace: kube-system
  labels:
    tier: node
    app: cidr-filtering-cni
    name: cidr-filtering-cni
spec:
  selector:
    matchLabels:
      name: cidr-filtering-cni
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        tier: node
        app: cidr-filtering-cni
        name: cidr-filtering-cni
    spec:
      tolerations:
      - operator: Exists
        effect: NoSchedule
      - operator: Exists
        effect: NoExecute
      serviceAccountName: cidr-filtering
      initContainers:
      - name: cidr-filtering-cni-copier
        image: registry.access.redhat.com/ubi8/ubi:8.6-754
        env:
        - name: CNI_NAME
          value: cidr-filtering-cni
        - name: CNI_CONF_DIR
          value: "/host/etc/cni/net.d"
        - name: SCRIPT
          value: "IyEvYmluL2Jhc2gKCnNldCAtZXVvIHBpcGVmYWlsCgpzdGRpbj0kKGNhdCAvZGV2L3N0ZGluKQpsb2dGaWxlPSIke0xPR0ZJTEU6LS92YXIvbG9nL2NpZHItZmlsdGVyaW5nLWNuaS5sb2d9IgoKZXhlYyAyPj4gJGxvZ0ZpbGUKCk5GVF9UQUJMRV9ORVRERVY9bmV0ZGV2Ck5GVF9UQUJMRV9CUklER0U9YnJpZGdlCk5GVF9UQUJMRT1maWx0ZXIKCk5GVF9JTkdSRVNTX0NIQUlOPWluZ3Jlc3MKTkZUX0lOR1JFU1NfSE9PSz1pbmdyZXNzCgpORlRfUE9TVFJPVVRJTkdfQ0hBSU49cG9zdHJvdXRpbmcKTkZUX0VHUkVTU19IT09LPXBvc3Ryb3V0aW5nCgpnZXRfb2JqZWN0KCkgewogICAgbG9jYWwganNvbl9vYmplY3Q9IiQxIgogICAgbG9jYWwganNvbl9wYXRoPSIkMiIKICAgIGVjaG8gIiRqc29uX29iamVjdCIgfCBqcSAtY3IgIiRqc29uX3BhdGgiCn0KCmdldF9hcnJheV9pdGVtcygpIHsKICAgIGxvY2FsIGpzb25fb2JqZWN0PSIkMSIKICAgIGxvY2FsIGpzb25fcGF0aD0iJDIiCiAgICBlY2hvICIkanNvbl9vYmplY3QiIHwganEgLWMgJGpzb25fcGF0aCB8IGpxIC1jciAiLltdIgp9CgpnZXRfYXJyYXlfbGVuKCkgewogICAgbG9jYWwganNvbl9vYmplY3Q9IiQxIgogICAgbG9jYWwganNvbl9wYXRoPSIkMiIKICAgIGVjaG8gIiRqc29uX29iamVjdCIgfCBqcSAtYyAiJGpzb25fcGF0aCIgfCBqcSAiLiB8IGxlbmd0aCIKfQoKZm9yX2pzb25fYXJyYXkoKSB7CiAgICBsb2NhbCBqc29uX29iamVjdD0iJDEiCiAgICBsb2NhbCBqc29uX3BhdGg9IiQyIgogICAgbG9jYWwgZm49IiQzIgogICAgZm9yIGl0ZW0gaW4gJChnZXRfYXJyYXlfaXRlbXMgIiRqc29uX29iamVjdCIgIiRqc29uX3BhdGgiKTsgZG8KICAgICAgICAkZm4gJGl0ZW0KICAgIGRvbmUKfQoKZ2V0X2lwX3ZlcnNpb24oKSB7CiAgICBsb2NhbCBpcF9hZGRyZXNzPSIkMSIKICAgIGlmIFtbICIkaXBfYWRkcmVzcyIgPX4gLio6LiogXV0KICAgIHRoZW4KICAgICAgICBlY2hvICJpcDYiCiAgICBlbHNlCiAgICAgICAgZWNobyAiaXAiCiAgICBmaQp9CnRlc3QKY3JlYXRlX3RhYmxlKCkgewogICAgbG9jYWwgdHlwZT0iJDEiCiAgICBsb2NhbCBuYW1lPSIkMiIKICAgIGVjaG8gIm5mdCBhZGQgdGFibGUgJHR5cGUgJG5hbWUiIHwgdGVlIC1hICRsb2dGaWxlCn0KCmNyZWF0ZV9uZXRkZXZfYmFzZV9jaGFpbigpIHsKICAgIGxvY2FsIHR5cGU9IiQxIgogICAgbG9jYWwgbmFtZT0iJDIiCiAgICBsb2NhbCBjaGFpbj0iJDMiCiAgICBsb2NhbCBob29rPSIkNCIKICAgIGxvY2FsIGRldmljZT0iJDUiCiAgICBlY2hvICJuZnQgYWRkIGNoYWluICR0eXBlICRuYW1lICRjaGFpbiB7IHR5cGUgZmlsdGVyIGhvb2sgJGhvb2sgZGV2aWNlICRkZXZpY2UgcHJpb3JpdHkgMDsgcG9saWN5IGFjY2VwdDsgfSIgfCB0ZWUgLWEgJGxvZ0ZpbGUKfQoKY3JlYXRlX2Jhc2VfY2hhaW4oKSB7CiAgICBsb2NhbCB0eXBlPSIkMSIKICAgIGxvY2FsIG5hbWU9IiQyIgogICAgbG9jYWwgY2hhaW49IiQzIgogICAgbG9jYWwgaG9vaz0iJDQiCiAgICBlY2hvICJuZnQgYWRkIGNoYWluICR0eXBlICRuYW1lICRjaGFpbiB7IHR5cGUgZmlsdGVyIGhvb2sgJGhvb2sgcHJpb3JpdHkgMDsgcG9saWN5IGFjY2VwdDsgfSIgfCB0ZWUgLWEgJGxvZ0ZpbGUKfQoKY3JlYXRlX2NoYWluKCkgewogICAgbG9jYWwgdHlwZT0iJDEiCiAgICBsb2NhbCBuYW1lPSIkMiIKICAgIGxvY2FsIGNoYWluPSIkMyIKICAgIGVjaG8gIm5mdCBhZGQgY2hhaW4gJHR5cGUgJG5hbWUgJGNoYWluIiB8IHRlZSAtYSAkbG9nRmlsZQp9CgpuZnRfYWRkX3J1bGUoKSB7CiAgICBsb2NhbCB0eXBlPSIkMSIKICAgIGxvY2FsIHRhYmxlPSIkMiIKICAgIGxvY2FsIGNoYWluPSIkMyIKICAgIHNldCAtLSAiJHtAOjR9IgogICAgZWNobyAibmZ0IGFkZCBydWxlICR0eXBlICR0YWJsZSAkY2hhaW4gJEAiIHwgdGVlIC1hICRsb2dGaWxlCn0KCmNyZWF0ZV9ydWxlc19mb3JfZmlsdGVyaW5nKCkgewogICAgbG9jYWwgcG9saWN5X2lkPSIkMSIKICAgIGxvY2FsIHRhYmxlX3R5cGU9IiQyIgogICAgbG9jYWwgZGlyZWN0aW9uPSIkMyIKICAgIGxvY2FsIG1hdGNoX2lmYWNlPSIkNCIKICAgIAogICAgbG9jYWwgbWF0Y2hfYWRkcj0ic2FkZHIiCiAgICBpZiBbWyAiJGRpcmVjdGlvbiIgPT0gImVncmVzcyIgXV07IHRoZW4KICAgICAgICBsb2NhbCBtYXRjaF9hZGRyPSJkYWRkciIKICAgIGZpCiAgICAKICAgIF9jcmVhdGVfc3VibmV0X3J1bGUoKSB7CiAgICAgICAgbG9jYWwgc3VibmV0PSQxCiAgICAgICAgaWYgW1sgIiQoZ2V0X29iamVjdCAiJHtzdWJuZXR9IiAiLnN1Ym5ldC5leGNlcHQiKSIgIT0gIm51bGwiIF1dOyB0aGVuCiAgICAgICAgICAgIGZvcl9qc29uX2FycmF5ICIke3N1Ym5ldH0iICIuc3VibmV0LmV4Y2VwdCIgX2Ryb3BfaXAKICAgICAgICBmaQoKICAgICAgICBpZiBbWyAiJChnZXRfb2JqZWN0ICIke3N1Ym5ldH0iICIuc3VibmV0LmNpZHIiKSIgPT0gIm51bGwiIF1dOyB0aGVuCiAgICAgICAgICAgIGV4aXRXaXRoRXJyb3IgImNpZHIgbXVzdCBiZSBzcGVjaWZpZWQuIgogICAgICAgIGZpCiAgICAgICAgX2FjY2VwdF9jaWRyICIke3N1Ym5ldH0iCiAgICB9CgogICAgX2Ryb3BfaXAoKSB7CiAgICAgICAgbG9jYWwgaXA9IiQxIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICR7dGFibGVfdHlwZX0gJHtORlRfVEFCTEV9IG0tJHtwb2xpY3lfaWR9LSR7ZGlyZWN0aW9ufS1zdWJuZXRzICR7bWF0Y2hfaWZhY2V9ICRDTklfSUZOQU1FICQoZ2V0X2lwX3ZlcnNpb24gIiR7aXB9IikgJHttYXRjaF9hZGRyfSAiJHtpcH0iIGNvdW50ZXIgZHJvcCkKICAgIH0KCiAgICBfYWNjZXB0X2NpZHIoKSB7CiAgICAgICAgbG9jYWwgc3VibmV0PSIkMSIKICAgICAgICBsb2NhbCBjaWRyPSQoZWNobyAiJHtzdWJuZXR9IiB8IGpxIC1yICIuc3VibmV0LmNpZHIiKQogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICR7dGFibGVfdHlwZX0gJHtORlRfVEFCTEV9IG0tJHtwb2xpY3lfaWR9LSR7ZGlyZWN0aW9ufS1zdWJuZXRzICR7bWF0Y2hfaWZhY2V9ICRDTklfSUZOQU1FICQoZ2V0X2lwX3ZlcnNpb24gIiR7Y2lkcn0iKSAke21hdGNoX2FkZHJ9ICIke2NpZHJ9IiBjb3VudGVyIG1ldGEgbWFyayBzZXQgbWFyayBvciAweDIwMDAwKQogICAgfQoKICAgIF9hY2NlcHRfcG9ydCgpIHsKICAgICAgICBsb2NhbCBwb3J0cz0iJDEiCiAgICAgICAgbG9jYWwgcG9ydD0kKGVjaG8gIiRwb3J0cyIgfCBqcSAtciAiLnBvcnQiKQogICAgICAgIGxvY2FsIHByb3RvY29sPSQoZWNobyAiJHBvcnRzIiB8IGpxIC1yICIucHJvdG9jb2wiKQoKICAgICAgICBpZiBbWyAiJHBvcnQiID09ICJudWxsIiB8fCAiJHByb3RvY29sIiA9PSAibnVsbCIgfHwgIiRwb3J0IiA9PSAiIiB8fCAiJHByb3RvY29sIiA9PSAiIiBdXTsgdGhlbgogICAgICAgICAgICBleGl0V2l0aEVycm9yICJQb3J0IGFuZCBwcm90b2NvbCBtdXN0IGJlIHNwZWNpZmllZC4iCiAgICAgICAgZWxzZQogICAgICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAke3RhYmxlX3R5cGV9ICR7TkZUX1RBQkxFfSBtLSR7cG9saWN5X2lkfS0ke2RpcmVjdGlvbn0tcG9ydHMgJHttYXRjaF9pZmFjZX0gJENOSV9JRk5BTUUgJHtwcm90b2NvbCwsfSBkcG9ydCAke3BvcnR9IGNvdW50ZXIgbWV0YSBtYXJrIHNldCBtZXRhIG1hcmsgInwiIDB4MDAwMTAwMDApCiAgICAgICAgZmkKICAgIH0KCiAgICAjIGhhbmRsZSBpcCBibG9jawogICAgaWYgW1sgJChlY2hvICIkc3RkaW4iIHwganEgLXIgIi4ke2RpcmVjdGlvbn0uc3VibmV0cyIpICE9ICJudWxsIiBdXTsgdGhlbgogICAgICAgIGZvcl9qc29uX2FycmF5ICIkc3RkaW4iICIuJHtkaXJlY3Rpb259LnN1Ym5ldHMiIF9jcmVhdGVfc3VibmV0X3J1bGUKICAgIGZpCgogICAgIyBoYW5kbGUgcG9ydHMKICAgIGlmIFtbICQoZWNobyAiJHN0ZGluIiB8IGpxIC1yICIuJHtkaXJlY3Rpb259LnBvcnRzIikgIT0gIm51bGwiIF1dOyB0aGVuCiAgICAgICAgZm9yX2pzb25fYXJyYXkgIiRzdGRpbiIgIi4ke2RpcmVjdGlvbn0ucG9ydHMiIF9hY2NlcHRfcG9ydAogICAgZmkKfQoKZXhpdFdpdGhFcnJvcigpIHsKICAgIGVjaG8gInsiY25pVmVyc2lvbiI6ICIkKGpxIC1yICIuY25pVmVyc2lvbiIgPDw8ICIkc3RkaW4iKSIsIm1zZyI6IiQxIiwiY29kZSI6MTAxLCJkZXRhaWxzIjoiJDIifSIKICAgIGV4aXQgMQp9CgpleGl0V2l0aFN1Y2Nlc3MoKSB7CiAgICBwcmV2X3Jlc3VsdD0kKGdldF9vYmplY3QgIiR7c3RkaW59IiAiLnByZXZSZXN1bHQiKQogICAgaWYgW1sgIiRwcmV2X3Jlc3VsdCIgPT0gIm51bGwiIF1dOyB0aGVuCiAgICAgICAgZWNobyAieyJjbmlWZXJzaW9uIjogIiQoanEgLXIgIi5jbmlWZXJzaW9uIiA8PDwgIiRzdGRpbiIpIn0iCiAgICBlbHNlCiAgICAgICAgZWNobyAiJHByZXZfcmVzdWx0IgogICAgZmkKICAgIGV4aXQgMAp9CgpjcmVhdGVfY2hhaW5zX2Zvcl9maWx0ZXJpbmcoKSB7CiAgICBsb2NhbCBwb2xpY3lfaWQ9IiQxIgogICAgbG9jYWwgdGFibGVfdHlwZT0iJDIiCiAgICBsb2NhbCBkaXJlY3Rpb249IiQzIgoKICAgIGxvY2FsIG1hdGNoX2lmYWNlPSJpaWZuYW1lIgogICAgaWYgW1sgIiRkaXJlY3Rpb24iID09ICJlZ3Jlc3MiIF1dOyB0aGVuCiAgICAgICAgbWF0Y2hfaWZhY2U9Im9pZm5hbWUiCiAgICBmaQoKICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQoY3JlYXRlX2NoYWluICIke3RhYmxlX3R5cGV9IiAiJHtORlRfVEFCTEV9IiBtLSIke3BvbGljeV9pZH0iLSIke2RpcmVjdGlvbn0iKSB8fCBleGl0V2l0aEVycm9yICJGYWlsZWQgdG8gYWRkIGNoYWluIG0tJHtwb2xpY3lfaWR9LSR7ZGlyZWN0aW9ufSIKICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICIke3RhYmxlX3R5cGV9IiAiJHtORlRfVEFCTEV9IiBtLSIke2RpcmVjdGlvbn0iICIke21hdGNoX2lmYWNlfSIgIiRDTklfSUZOQU1FIiBjb3VudGVyIGp1bXAgbS0iJHtwb2xpY3lfaWR9Ii0iJHtkaXJlY3Rpb259IikgfHwgZXhpdFdpdGhFcnJvciAiRmFpbGVkIHRvIGFkZCBydWxlOiBqdW1wIG0tJHtwb2xpY3lfaWR9LSR7ZGlyZWN0aW9ufSIKCiAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKGNyZWF0ZV9jaGFpbiAiJHt0YWJsZV90eXBlfSIgIiR7TkZUX1RBQkxFfSIgbS0iJHtwb2xpY3lfaWR9Ii0iJHtkaXJlY3Rpb259Ii1zdWJuZXRzKSB8fCBleGl0V2l0aEVycm9yICJGYWlsZWQgdG8gYWRkIGNoYWluIG0tIiR7cG9saWN5X2lkfSItIiR7ZGlyZWN0aW9ufSItc3VibmV0cyIKICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQoY3JlYXRlX2NoYWluICIke3RhYmxlX3R5cGV9IiAiJHtORlRfVEFCTEV9IiBtLSIke3BvbGljeV9pZH0iLSIke2RpcmVjdGlvbn0iLXBvcnRzKSB8fCBleGl0V2l0aEVycm9yICJGYWlsZWQgdG8gYWRkIGNoYWluIG0tIiR7cG9saWN5X2lkfSItIiR7ZGlyZWN0aW9ufSItcG9ydHMiCiAgICAKICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICIke3RhYmxlX3R5cGV9IiAiJHtORlRfVEFCTEV9IiBtLSIke3BvbGljeV9pZH0iLSIke2RpcmVjdGlvbn0iIGNvdW50ZXIganVtcCBtLSIke3BvbGljeV9pZH0iLSIke2RpcmVjdGlvbn0iLXN1Ym5ldHMpIHx8IGV4aXRXaXRoRXJyb3IgIkZhaWxlZCB0byBhZGQgcnVsZToganVtcCBtLSIke3BvbGljeV9pZH0iLSIke2RpcmVjdGlvbn0iLXN1Ym5ldHMiCiAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAiJHt0YWJsZV90eXBlfSIgIiR7TkZUX1RBQkxFfSIgbS0iJHtwb2xpY3lfaWR9Ii0iJHtkaXJlY3Rpb259IiBjb3VudGVyIGp1bXAgbS0iJHtwb2xpY3lfaWR9Ii0iJHtkaXJlY3Rpb259Ii1wb3J0cykgfHwgZXhpdFdpdGhFcnJvciAiRmFpbGVkIHRvIGFkZCBydWxlOiBqdW1wIG0tIiR7cG9saWN5X2lkfSItIiR7ZGlyZWN0aW9ufSItcG9ydHMiCgogICAgY3JlYXRlX3J1bGVzX2Zvcl9maWx0ZXJpbmcgIiR7cG9saWN5X2lkfSIgIiR7dGFibGVfdHlwZX0iICIke2RpcmVjdGlvbn0iICIke21hdGNoX2lmYWNlfSIKfQoKbWFpbigpIHsKICAgIGNhc2UgJENOSV9DT01NQU5EIGluCiAgICBBREQpCiAgICAgICAgZWNobyAiQ05JX05FVE5TOiAkQ05JX05FVE5TIiA+PiAkbG9nRmlsZQogICAgICAgIGVjaG8gIkNOSV9DT05UQUlORVJJRDogJENOSV9DT05UQUlORVJJRCIgPj4gJGxvZ0ZpbGUKICAgICAgICBlY2hvICJTVERJTjogJHN0ZGluIiA+PiAkbG9nRmlsZQoKICAgICAgICBsb2NhbCBwb2xpY3lfbmFtZT0kKGVjaG8gIiRzdGRpbiIgfCBqcSAtciAiLm5hbWUiKQogICAgICAgIGxvY2FsIHBvbGljeV9pZD0iJChlY2hvICIkcG9saWN5X25hbWUiIHwgc2hhMXN1bSApIgogICAgICAgIHBvbGljeV9pZD0iJHtwb2xpY3lfaWQ6MDo1fSIgIyB1c2UgZmlyc3QgNSBjaGFyYWN0ZXJzIHRvIGlkZW50aWZ5IGEgcG9saWN5CgogICAgICAgIG1rZGlyIC1wIC92YXIvcnVuL25ldG5zLwogICAgICAgIGxuIC1zZlQgIiRDTklfTkVUTlMiIC92YXIvcnVuL25ldG5zLyIke0NOSV9DT05UQUlORVJJRH0iCgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQoY3JlYXRlX3RhYmxlICR7TkZUX1RBQkxFX0JSSURHRX0gJHtORlRfVEFCTEV9KSB8fCBleGl0V2l0aEVycm9yICJGYWlsZWQgdG8gY3JlYXRlIHRhYmxlICR7TkZUX1RBQkxFX0JSSURHRX0gJHtORlRfVEFCTEV9IgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQoY3JlYXRlX3RhYmxlICR7TkZUX1RBQkxFX05FVERFVn0gJHtORlRfVEFCTEV9KSB8fCBleGl0V2l0aEVycm9yICJGYWlsZWQgdG8gY3JlYXRlIHRhYmxlICR7TkZUX1RBQkxFX0JSSURHRX0gJHtORlRfVEFCTEV9IgoKICAgICAgICAjIGNyZWF0ZSBiYXNlIGNoYWlucwogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQoY3JlYXRlX25ldGRldl9iYXNlX2NoYWluICR7TkZUX1RBQkxFX05FVERFVn0gJHtORlRfVEFCTEV9ICR7TkZUX0lOR1JFU1NfQ0hBSU59ICR7TkZUX0lOR1JFU1NfSE9PS30gJHtDTklfSUZOQU1FfSkgfHwgZXhpdFdpdGhFcnJvciAiRmFpbGVkIHRvIGNyZWF0ZSBuZXRkZXYgYmFzZSBjaGFpbiAke05GVF9JTkdSRVNTX0NIQUlOfSIKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKGNyZWF0ZV9iYXNlX2NoYWluICR7TkZUX1RBQkxFX0JSSURHRX0gJHtORlRfVEFCTEV9ICR7TkZUX1BPU1RST1VUSU5HX0NIQUlOfSAke05GVF9FR1JFU1NfSE9PS30pIHx8IGV4aXRXaXRoRXJyb3IgIkZhaWxlZCB0byBjcmVhdGUgYnJpZGdlIGJhc2UgY2hhaW4gJHtORlRfUE9TVFJPVVRJTkdfQ0hBSU59IgoKICAgICAgICAjIGZpbHRlciBjaGFpbnMKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKGNyZWF0ZV9jaGFpbiAke05GVF9UQUJMRV9ORVRERVZ9ICR7TkZUX1RBQkxFfSBtLWluZ3Jlc3MpIHx8IGV4aXRXaXRoRXJyb3IgIkZhaWxlZCB0byBhZGQgY2hhaW4gbS1pbmdyZXNzIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQoY3JlYXRlX2NoYWluICR7TkZUX1RBQkxFX0JSSURHRX0gJHtORlRfVEFCTEV9IG0tZWdyZXNzKSB8fCBleGl0V2l0aEVycm9yICJGYWlsZWQgdG8gYWRkIGNoYWluIG0tZWdyZXNzIgoKICAgICAgICAjIHNldHVwIHByZXJvdXRpbmcgY2hhaW4KICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAke05GVF9UQUJMRV9ORVRERVZ9ICR7TkZUX1RBQkxFfSAke05GVF9JTkdSRVNTX0NIQUlOfSBldGhlciB0eXBlIGFycCBjb3VudGVyIGFjY2VwdCkgfHwgZXhpdFdpdGhFcnJvciAiRmFpbGVkIHRvIGFsbG93IGFycCBmb3IgaW5ncmVzcyIKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAke05GVF9UQUJMRV9ORVRERVZ9ICR7TkZUX1RBQkxFfSAke05GVF9JTkdSRVNTX0NIQUlOfSBpaWZuYW1lICRDTklfSUZOQU1FIGNvdW50ZXIganVtcCBtLWluZ3Jlc3MpIHx8IGV4aXRXaXRoRXJyb3IgIkZhaWxlZCB0byBhZGQgcnVsZToganVtcCBtLWluZ3Jlc3MiCgogICAgICAgICMgc2V0dXAgcG9zdHJvdXRpbmcgY2hhaW4KICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAke05GVF9UQUJMRV9CUklER0V9ICR7TkZUX1RBQkxFfSAke05GVF9QT1NUUk9VVElOR19DSEFJTn0gZXRoZXIgdHlwZSBhcnAgY291bnRlciBhY2NlcHQpIHx8IGV4aXRXaXRoRXJyb3IgIkZhaWxlZCB0byBhbGxvdyBhcnAgZm9yIGVncmVzcyIKICAgICAgICBpcCBuZXRucyBleGVjICIkQ05JX0NPTlRBSU5FUklEIiAkKG5mdF9hZGRfcnVsZSAke05GVF9UQUJMRV9CUklER0V9ICR7TkZUX1RBQkxFfSAke05GVF9QT1NUUk9VVElOR19DSEFJTn0gb2lmbmFtZSAkQ05JX0lGTkFNRSBjb3VudGVyIGp1bXAgbS1lZ3Jlc3MpIHx8IGV4aXRXaXRoRXJyb3IgIkZhaWxlZCB0byBhZGQgcnVsZToganVtcCBtLWVncmVzcyIKCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgIiR7TkZUX1RBQkxFX05FVERFVn0iICIke05GVF9UQUJMRX0iIG0taW5ncmVzcyBjb3VudGVyIG1ldGEgbWFyayBzZXQgbWV0YSBtYXJrICImIiAweGZmZmNmZmZmKSB8fCBleGl0V2l0aEVycm9yICJGYWlsZWQgdG8gYWRkIHJ1bGU6IHNldCBtZXRhIG1hcmsgJiAweGZmZmNmZmZmIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICIke05GVF9UQUJMRV9CUklER0V9IiAiJHtORlRfVEFCTEV9IiBtLWVncmVzcyBjb3VudGVyIG1ldGEgbWFyayBzZXQgbWV0YSBtYXJrICImIiAweGZmZmNmZmZmKSB8fCBleGl0V2l0aEVycm9yICJGYWlsZWQgdG8gYWRkIHJ1bGU6IHNldCBtZXRhIG1hcmsgJiAweGZmZmNmZmZmIgoKICAgICAgICBjcmVhdGVfY2hhaW5zX2Zvcl9maWx0ZXJpbmcgJHBvbGljeV9pZCAke05GVF9UQUJMRV9ORVRERVZ9ICJpbmdyZXNzIgogICAgICAgIGNyZWF0ZV9jaGFpbnNfZm9yX2ZpbHRlcmluZyAkcG9saWN5X2lkICR7TkZUX1RBQkxFX0JSSURHRX0gImVncmVzcyIKCiAgICAgICAgaXAgbmV0bnMgZXhlYyAiJENOSV9DT05UQUlORVJJRCIgJChuZnRfYWRkX3J1bGUgIiR7TkZUX1RBQkxFX05FVERFVn0iICIke05GVF9UQUJMRX0iIG0taW5ncmVzcyBtZXRhIG1hcmsgIiYiIDB4MDAwMzAwMDAgPT0gMHgwMDAzMDAwMCBjb3VudGVyIHJldHVybikgfHwgZXhpdFdpdGhFcnJvciAiRmFpbGVkIHRvIGFkZCBydWxlOiBtYXJrICYgMHgwMDAzMDAwMCA9PSAweDAwMDMwMDAwIGNvdW50ZXIgcmV0dXJuIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICIke05GVF9UQUJMRV9ORVRERVZ9IiAiJHtORlRfVEFCTEV9IiBtLWluZ3Jlc3MgY291bnRlciBkcm9wKSB8fCBleGl0V2l0aEVycm9yICJGYWlsZWQgdG8gYWRkIHJ1bGU6IGRyb3AiCgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICIke05GVF9UQUJMRV9CUklER0V9IiAiJHtORlRfVEFCTEV9IiBtLWVncmVzcyBtZXRhIG1hcmsgIiYiIDB4MDAwMzAwMDAgPT0gMHgwMDAzMDAwMCBjb3VudGVyIHJldHVybikgfHwgZXhpdFdpdGhFcnJvciAiRmFpbGVkIHRvIGFkZCBydWxlOiBtYXJrICYgMHgwMDAzMDAwMCA9PSAweDAwMDMwMDAwIGNvdW50ZXIgcmV0dXJuIgogICAgICAgIGlwIG5ldG5zIGV4ZWMgIiRDTklfQ09OVEFJTkVSSUQiICQobmZ0X2FkZF9ydWxlICIke05GVF9UQUJMRV9CUklER0V9IiAiJHtORlRfVEFCTEV9IiBtLWVncmVzcyBjb3VudGVyIGRyb3ApIHx8IGV4aXRXaXRoRXJyb3IgIkZhaWxlZCB0byBhZGQgcnVsZTogZHJvcCIKCiAgICAgICAgZXhpdFdpdGhTdWNjZXNzCiAgICA7OwoKICAgIERFTCkKICAgICAgICBlY2hvICJEZWxldGUgJENOSV9DT05UQUlORVJJRCIgPj4gJGxvZ0ZpbGUKICAgICAgICBybSAtZiAvdmFyL3J1bi9uZXRucy8iJENOSV9DT05UQUlORVJJRCIKICAgIDs7CgogICAgVkVSU0lPTikKICAgICAgICBlY2hvICJ7ImNuaVZlcnNpb24iOiIwLjMuMSIsInN1cHBvcnRlZFZlcnNpb25zIjpbIjAuMS4wIiwiMC4yLjAiLCIwLjMuMCIsIjAuMy4xIl19IgogICAgOzsKCiAgICAqKQogICAgICAgIGV4aXRXaXRoRXJyb3IgIlVucmVjb2duaXplZCBDTkkgY29tbWFuZDogJHtDTklfQ09NTUFORH0iCiAgICA7OwoKICAgIGVzYWMKfQoKbWFpbgo="
        securityContext:
          privileged: true
        volumeMounts:
        - name: cni
          mountPath: /host/etc/cni/net.d
        - name: cnibin
          mountPath: /host/opt/cni/bin
        command:
          - /bin/bash
          - -c
          - |
            echo $(SCRIPT) | base64 -d > /host/opt/cni/bin/$(CNI_NAME) &&\
            chmod +x /host/opt/cni/bin/$(CNI_NAME)

            # Inspired by: https://tinyurl.com/y7r2knme
            CIDR_TEMP_KUBECONFIG="/tmp/cidr-filtering.kubeconfig"
            CIDR_KUBECONFIG_FILE_HOST=$(CNI_CONF_DIR)/cidr-filtering.d/cidr-filtering.kubeconfig
            mkdir -p $(CNI_CONF_DIR)/cidr-filtering.d
            

            SERVICE_ACCOUNT_PATH=/var/run/secrets/kubernetes.io/serviceaccount
            KUBE_CA_FILE=${KUBE_CA_FILE:-$SERVICE_ACCOUNT_PATH/ca.crt}
            SERVICEACCOUNT_TOKEN=$(cat $SERVICE_ACCOUNT_PATH/token)
            SKIP_TLS_VERIFY=${SKIP_TLS_VERIFY:-false}

            # Check if we're running as a k8s pod.
            if [ -f "$SERVICE_ACCOUNT_PATH/token" ]; then
              # We're running as a k8d pod - expect some variables.
              if [ -z ${KUBERNETES_SERVICE_HOST} ]; then
                error "KUBERNETES_SERVICE_HOST not set"; exit 1;
              fi
              if [ -z ${KUBERNETES_SERVICE_PORT} ]; then
                error "KUBERNETES_SERVICE_PORT not set"; exit 1;
              fi

              if [ "$SKIP_TLS_VERIFY" == "true" ]; then
                TLS_CFG="insecure-skip-tls-verify: true"
              elif [ -f "$KUBE_CA_FILE" ]; then
                TLS_CFG="certificate-authority-data: $(cat $KUBE_CA_FILE | base64 | tr -d '\n')"
              fi

              # Write a kubeconfig file for the CNI plugin.  Do this
              # to skip TLS verification for now.  We should eventually support
              # writing more complete kubeconfig files. This is only used
              # if the provided CNI network config references it.
              touch $CIDR_TEMP_KUBECONFIG
              chmod ${KUBECONFIG_MODE:-600} $CIDR_TEMP_KUBECONFIG
              # Write the kubeconfig to a temp file first.
              cat > $CIDR_TEMP_KUBECONFIG <<EOF
            # Kubeconfig file for CIDR CNI plugin.
            apiVersion: v1
            kind: Config
            clusters:
            - name: local
              cluster:
                server: ${KUBERNETES_SERVICE_PROTOCOL:-https}://[${KUBERNETES_SERVICE_HOST}]:${KUBERNETES_SERVICE_PORT}
                $TLS_CFG
            users:
            - name: cidr-filtering
              user:
                token: "${SERVICEACCOUNT_TOKEN}"
            contexts:
            - name: cidr-filtering-context
              context:
                cluster: local
                user: cidr-filtering
            current-context: cidr-filtering-context
            EOF

              # Atomically move the temp kubeconfig to its permanent home.
              mv -f $CIDR_TEMP_KUBECONFIG $CIDR_KUBECONFIG_FILE_HOST
            else
              warn "Doesn't look like we're running in a kubernetes environment (no serviceaccount token)"
            fi
      containers:
      - name: cidr-filtering-cni
        image: registry.access.redhat.com/ubi8/ubi:8.6-754
        command: ["sleep"]
        args: ["infinity"]
        resources:
          requests:
            cpu: "10m"
            memory: "25Mi"
          limits:
            cpu: "10m"
            memory: "25Mi"
      terminationGracePeriodSeconds: 10
      volumes:
      - name: cni
        hostPath:
          path: /etc/cni/net.d
      - name: cnibin
        hostPath:
          path: /opt/cni/bin
